# 工作流设计模式

## 1. Checkpoint-Resumable Workflow 模式

适用于**长程任务**的工作流设计，通过文档 checkpoint 实现跨对话的中断与恢复。

### 1.1 核心原则：持久化优先

**任务开始时立即创建状态文档**，而非"可能中断时才写"。

这确保：
- 随时可切换对话（Token 耗尽、异常、用户主动切换）
- 任何时刻状态可追溯
- 上下文永不丢失

### 1.2 适用场景

| 场景 | 是否适用 |
|------|----------|
| 任务步骤 ≥ 3 | ✅ |
| 可能跨多次对话 | ✅ |
| 需要用户决策点 | ✅ |
| 需要追踪进度 | ✅ |
| 简单的 1-2 步任务 | ❌ |

### 1.3 必要组件

```
workflow-name/
├── SKILL.md              # 工作流入口
├── references/
│   └── workflow.md       # 详细流程说明
└── scripts/
    └── generate_xxx.py   # 文档生成脚本（可选）
```

### 1.4 状态文档要素

状态文档（如 Plan/Log/Diag 文件）必须包含：

| 要素 | 说明 | 示例 |
|------|------|------|
| **任务标识** | 唯一标识，便于定位 | 日期+序号+类型+名称 |
| **检查点列表** | 可追踪的阶段划分 | CP1, CP2, CP3... |
| **状态标记** | 统一的进度标记 | ⬜ 待开始 / 🔄 进行中 / ✅ 已完成 |
| **当前状态** | 进度 + 下一步操作 | "CP2 进行中，下一步：xxx" |
| **时间戳** | 各阶段的完成时间 | 2026-01-24 |

### 1.5 状态文档模板

```markdown
# [任务名称]

## 状态总览

| 检查点 | 状态 | 完成时间 |
|--------|------|----------|
| CP1: xxx | ✅ 已完成 | 2026-01-24 |
| CP2: xxx | 🔄 进行中 | - |
| CP3: xxx | ⬜ 待开始 | - |

## 当前状态

**进度**：CP2 进行中
**下一步**：[具体操作]

---

## 详细记录

### CP1: xxx
- 执行内容...
- 产出物...
```

### 1.6 工作流程

```
任务开始
    ↓
立即创建状态文档（CP1: 🔄）
    ↓
执行 CP1
    ↓
更新文档（CP1: ✅，CP2: 🔄）
    ↓
...继续或中断...
    ↓
[新对话] 读取状态文档 → 从"当前状态"继续
    ↓
任务完成 → 更新最终状态，归档
```

### 1.7 SKILL.md 必要内容

采用此模式的 SKILL.md 必须包含：

```markdown
## ⚠️ 核心强制要求

### 触发条件
- [明确的触发条件]

### 必须执行的流程
1. [检查点1]
2. [检查点2]
...

## AI Agent 行为要求

### 文档创建
任务开始时**立即创建**状态文档

### 状态更新
每个检查点完成后**立即更新**状态

### 恢复执行
新对话读取状态文档，从"当前状态"继续
```

### 1.8 设计检查清单

创建 Checkpoint-Resumable 工作流前检查：

- [ ] 确认任务符合适用场景
- [ ] 定义明确的触发条件
- [ ] 设计合理的检查点划分（每个 CP 可独立验证）
- [ ] 状态文档包含"当前状态"部分（进度 + 下一步）
- [ ] AI Agent 行为要求覆盖：文档创建、状态更新、恢复执行
- [ ] 提供文档生成脚本（复杂场景）

---

## 2. 现有实例

| Skill | 状态文档 | 检查点 |
|-------|----------|--------|
| task-planning | `agent-task-log/PLAN_*.md` | CP1, CP2, CP3... |
| task-closure | `agent-task-log/archive/*.md` | 日志生成、六维分析 |

---

## 3. 何时不需要此模式

- 简单任务（1-2 步）
- 一次对话可完成的任务
- 无需用户决策的自动化流程
- 无需追踪进度的即时操作
