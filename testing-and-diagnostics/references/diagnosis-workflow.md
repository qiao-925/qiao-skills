# 诊断流程详细说明

## 1. 触发条件

- 测试失败
- 出现异常
- 用户要求复盘诊断

## 2. 诊断流程

### 2.1 三轮排查机制

```
第一轮排查
    ↓
观察 → 推断 → 操作 → 结果
    ↓
[未解决]
    ↓
第二轮排查
    ↓
观察 → 推断 → 操作 → 结果
    ↓
[未解决]
    ↓
第三轮排查
    ↓
观察 → 推断 → 操作 → 结果
    ↓
[未解决] → 升级给用户
```

### 2.2 单轮结构

| 步骤 | 内容 | 示例 |
|------|------|------|
| 观察 | 收集错误信息 | 堆栈、日志、截图 |
| 推断 | 分析可能原因 | 依赖问题、配置错误 |
| 操作 | 执行修复尝试 | 修改代码、更新配置 |
| 结果 | 验证是否解决 | 重新运行测试 |

## 3. 诊断记录模板（支持跨对话恢复）

```markdown
## 诊断记录

### 状态总览

| 轮次 | 状态 | 结果 |
|------|------|------|
| 第一轮 | ✅ 已完成 | 未解决 |
| 第二轮 | 🔄 进行中 | - |
| 第三轮 | ⬜ 待开始 | - |

### 恢复指引

当前进度：第二轮诊断进行中
错误类型：`AttributeError: 'NoneType' has no attribute 'query'`
下一步：验证配置加载修复是否生效

---

### 第一轮

**观察**：
- 错误信息：`AttributeError: 'NoneType' has no attribute 'query'`
- 发生位置：`src/query/engine.py:42`

**推断**：
- 可能原因：IndexManager 未正确初始化

**操作**：
- 检查 IndexManager 初始化代码
- 添加空值检查

**结果**：
- ❌ 问题仍存在

### 第二轮

**观察**：
- 发现配置文件缺少必需字段

**推断**：
- 配置加载顺序问题

**操作**：
- 修复配置加载逻辑

**结果**：
- ✅ 问题解决
```

## 4. 升级条件

以下情况必须升级给用户：

| 条件 | 说明 |
|------|------|
| 三轮排查无果 | 已尝试三次仍未解决 |
| 高风险操作 | 涉及数据库、生产环境 |
| 架构决策 | 需要重大设计变更 |
| 安全问题 | 涉及安全漏洞 |

## 5. 升级模板

```markdown
## 需要用户决策

### 问题描述
测试失败：test_query_engine

### 已尝试方案
1. 检查初始化逻辑 - 无效
2. 修复配置加载 - 无效
3. 重建索引 - 无效

### 风险评估
- 可能涉及数据一致性问题

### 后续选项
1. 方案 A：重构 QueryEngine（预估工作量大）
2. 方案 B：添加临时 workaround（技术债务）
3. 方案 C：暂时跳过该测试（风险：功能不稳定）

请选择后续方案。
```

## 6. 脚本使用

```bash
# 启动自动诊断
python scripts/auto_diagnose.py --error "test_query_engine failed"

# 参数说明
# --error: 错误描述
# --max-rounds: 最大排查轮数（默认 3）
# --verbose: 详细输出
```

## 7. 持久化机制（Checkpoint）

### 7.1 核心原则

**诊断开始时立即创建文档**，而非"可能中断时才写"。

这确保：
- 随时可切换对话
- Token 耗尽或异常不会丢失上下文
- 任何时刻状态可追溯

### 7.2 诊断文档

**位置**：`agent-task-log/DIAG_[日期]_[问题简述].md`

**创建时机**：测试失败，进入诊断流程时**立即创建**

**更新时机**：每轮诊断结束后**立即更新**状态

### 7.3 诊断文档模板

```markdown
# 诊断记录：[问题简述]

## 元信息

- 创建时间：2026-01-24
- 触发测试：test_query_engine
- 错误类型：AttributeError

## 状态总览

| 轮次 | 状态 | 结果 |
|------|------|------|
| 第一轮 | ✅ 已完成 | 未解决 |
| 第二轮 | 🔄 进行中 | - |
| 第三轮 | ⬜ 待开始 | - |

## 当前状态

**进度**：第二轮诊断进行中
**下一步**：验证配置加载修复是否生效

---

## 诊断记录

### 第一轮

**观察**：...
**推断**：...
**操作**：...
**结果**：❌ 未解决

### 第二轮

**观察**：...
**推断**：...
**操作**：（进行中）
```

### 7.4 工作流程

```
测试失败
    ↓
立即创建 DIAG_*.md（状态：第一轮 🔄）
    ↓
执行第一轮诊断
    ↓
更新文档（第一轮 ✅，第二轮 🔄）
    ↓
...继续或中断...
    ↓
[新对话] 读取 DIAG_*.md → 从当前状态继续
    ↓
诊断完成 → 更新最终状态，归档或删除
```

### 7.5 恢复执行

新对话开始诊断任务时：

1. 检查 `agent-task-log/DIAG_*.md` 是否存在未完成诊断
2. 若存在，读取"当前状态"部分
3. 从记录的下一步继续执行
